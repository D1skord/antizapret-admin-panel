# Админ-панель AntiZapret

Это монолитное веб-приложение для управления VPN-сервером AntiZapret. Приложение создано с использованием Go для бэкенда и Vue.js для фронтенда.

Главная особенность — приложение компилируется в **единый исполняемый файл**, который включает в себя и бэкенд-сервер, и фронтенд-интерфейс. Это упрощает развертывание на сервере.

## Структура проекта

-   `/`: Корень проекта, где находится исходный код бэкенда на Go.
-   `/frontend`: Исходный код фронтенда на Vue.js.
-   `go.mod`, `go.sum`: Файлы управления зависимостями в Go. `go.mod` определяет зависимости проекта, а `go.sum` содержит контрольные суммы для их проверки.
-   `main.go`: Главная точка входа для бэкенд-приложения.
-   `/internal`: Стандартная для Go директория, содержащая внутренние пакеты, которые не предназначены для использования другими приложениями.
    -   `internal/api`: Обработчики HTTP-запросов (API).
    -   `internal/middleware`: Промежуточное ПО (в данном случае, для аутентификации).
-   `/frontend/dist`: Скомпилированные ассеты фронтенда. Содержимое этой папки "встраивается" в финальный исполняемый файл Go.

## Технический стек

-   **Бэкенд**: Go с использованием фреймворка `gin-gonic/gin`.
-   **Фронтенд**: Vue.js 3 с Vite, Pinia для управления состоянием и Tailwind CSS для стилей.
-   **Развертывание**: Единый бинарный файл без внешних зависимостей (кроме самого AntiZapret).

## Фронтенд-тема и компоненты (TailAdmin)

Визуальный стиль админ-панели основан на бесплатном шаблоне **TailAdmin** для Vue.js. Мы не используем его как npm-библиотеку, а вручную переносим необходимые компоненты и стили.

Это дает нам полный контроль над кодом, но требует соблюдения определенного подхода при добавлении новых элементов.

### Как добавить новый компонент/страницу из TailAdmin

Предположим, вы хотите добавить страницу с формой из TailAdmin.

1.  **Найдите компонент в TailAdmin:** Сначала найдите нужный вам элемент в демо-версии TailAdmin. Затем откройте исходный код шаблона (если вы его удалили, склонируйте его снова) и найдите соответствующий `.vue` файл. Например, для форм это может быть `src/views/Forms/FormElements.vue`.

2.  **Найдите дочерние компоненты:** Откройте этот файл и посмотрите, какие компоненты он импортирует из `src/components/`. Например, он может импортировать `ComponentCard.vue` или кастомные инпуты.

3.  **Скопируйте файлы в ваш проект:**
    *   Скопируйте основной файл (например, `FormElements.vue`) в директорию `frontend/src/views/`.
    *   Скопируйте все его дочерние компоненты в `frontend/src/components/`, сохраняя структуру директорий.
    *   Если компоненты используют иконки или изображения, их также нужно скопировать в `frontend/src/icons/` или `frontend/public/images/`.

4.  **Адаптируйте код:**
    *   `tailAdmin` использует TypeScript. Вам нужно будет убрать аннотации типов из `<script setup lang="ts">` (просто `lang="ts"`) и из самого кода.
    *   Замените моковые (тестовые) данные на реальные данные из вашего приложения.
    *   Подключите ваши `stores` (Pinia) для управления состоянием.

5.  **Добавьте новый маршрут:** Откройте `frontend/src/router/index.js` и добавьте маршрут для новой страницы, обернув его в `AdminLayout`, если это страница внутри админ-панели.

6.  **Добавьте ссылку в сайдбар:** Откройте `frontend/src/components/layout/AppSidebar.vue` и добавьте новый `<li>` с `router-link` на вашу новую страницу. Не забудьте добавить иконку в `frontend/src/icons/index.js`, если нужна новая.


## Технические детали для начинающих в Go

### Встраивание фронтенда (`embed`)

В `main.go` вы увидите строку:
```go
//go:embed frontend/dist/*
var embeddedFiles embed.FS
```
Это специальная директива компилятора Go. Она говорит: "возьми все файлы из папки `frontend/dist` и вкомпилируй их прямо в исполняемый файл". `embeddedFiles` становится виртуальной файловой системой, из которой сервер может раздавать статические файлы (HTML, CSS, JS) без необходимости иметь их на диске рядом с запущенным приложением.

### Роутинг и раздача статики

Мы используем `gin-gonic/gin` — популярный и быстрый веб-фреймворк для Go.

В `main.go`:
1.  `router := gin.Default()`: Создается новый роутер Gin с базовым набором middleware (логирование, восстановление после паник).
2.  `fs.Sub(embeddedFiles, "frontend/dist")`: Мы получаем доступ к "под-директории" `frontend/dist` внутри нашей виртуальной файловой системы.
3.  `router.StaticFS("/", http.FS(staticFiles))`: Роутер настраивается так, чтобы раздавать статические файлы из этой виртуальной ФС по корневому пути `/`.
4.  `router.NoRoute(...)`: Если запрос не совпадает ни с одним API-маршрутом (например, `/api/clients`), он будет перенаправлен на `index.html`. Это нужно для Single-Page Application (SPA), где маршрутизацией на фронтенде управляет Vue Router.

### API и Middleware

-   **Группа маршрутов**: `apiGroup := router.Group("/api")` создает группу для всех маршрутов, начинающихся с `/api`.
-   **Middleware (`internal/middleware/auth.go`)**:
    -   Middleware — это функция, которая выполняется *до* основного обработчика запроса.
    -   `AuthMiddleware` проверяет наличие заголовка `X-Auth-Token`. Если токен неверный, он прерывает цепочку выполнения и немедленно отправляет ошибку `401 Unauthorized`.
    -   `protected.Use(middleware.AuthMiddleware())`: Применяет этот middleware ко всей группе маршрутов `/api/clients`.
-   **Обработчики (`internal/api/handlers.go`)**:
    -   Это функции, которые принимают `*gin.Context` и обрабатывают конкретный запрос.
    -   `c.ShouldBindJSON(&req)`: Автоматически парсит JSON из тела запроса в Go-структуру.
    -   `c.JSON(http.StatusOK, ...)`: Отправляет JSON-ответ с указанным HTTP-статусом.
    -   `os/exec`: В обработчиках есть закомментированные примеры использования `os/exec` для вызова внешних bash-команд (например, для взаимодействия со скриптами AntiZapret).

## Работа с проектом (Makefile)

Для упрощения разработки и сборки в проекте используется `Makefile`. Он предоставляет удобные команды для всех основных задач.

### Необходимые инструменты

-   Go (версии 1.21 или новее)
-   Node.js (версии 16 или новее) и npm
-   `make` для выполнения команд из Makefile

### 1. Установка зависимостей

Перед первым запуском необходимо установить все зависимости для бэкенда и фронтенда. Выполните команду:

```bash
make install-deps
```
Эта команда установит Go-модули (`go mod tidy`) и npm-пакеты (`npm install` в директории `frontend`).

### 2. Локальная разработка

Для одновременного запуска бэкенд-сервера (с hot-reload) и фронтенд-сервера разработки выполните:

```bash
make run
```
-   **Бэкенд** будет доступен на `http://localhost:8080`. Он автоматически перезапустится при изменении `.go` файлов. Для этого используется утилита `air`, которая установится автоматически при первом запуске.
-   **Фронтенд** будет доступен на `http://localhost:5173`. API-запросы будут автоматически проксироваться на бэкенд.

Если вы хотите запустить только бэкенд или только фронтенд, используйте отдельные команды в разных терминалах:
```bash
# Запустить только бэкенд с hot-reload
make dev-backend

# Запустить только фронтенд
make dev-frontend
```

Пароль для входа по умолчанию — `admin123`. Его можно изменить, установив переменную окружения `ADMIN_PASSWORD`.

### 3. Сборка для продакшена

Чтобы скомпилировать приложение в единый исполняемый файл для развертывания на сервере, выполните:

```bash
make build
```
Эта команда последовательно выполнит следующие шаги:
1.  Установит npm-зависимости (если нужно).
2.  Соберёт фронтенд-ассеты в директорию `frontend/dist`.
3.  Соберёт Go-приложение, встроив в него ассеты фронтенда.

В результате вы получите один файл `antizapret-admin` в корне проекта.

### 4. Запуск в продакшене

Загрузите файл `antizapret-admin` на ваш сервер и запустите его:
```bash
./antizapret-admin
```
Приложение будет доступно по адресу `http://localhost:8080` (или IP вашего сервера).

Для установки пароля при запуске используйте переменную окружения:
```bash
ADMIN_PASSWORD=ваш_супер_секретный_пароль ./antizapret-admin
```